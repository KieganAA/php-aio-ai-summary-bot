#!/usr/bin/env php
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';
ini_set('max_execution_time', '600');
ini_set('memory_limit', '1G');


use Src\Config\Config;
use Src\Console\ChatReportCommand;
use Src\Console\DailyDigestCommand;
use Src\Console\DailyReportCommand;
use Src\Console\ListChatsCommand;
use Src\Console\ResetProcessedCommand;
use Src\Repository\DbalMessageRepository;
use Src\Service\Database;
use Src\Service\Integrations\DeepseekService;
use Src\Service\Integrations\NotionService;
use Src\Service\Integrations\SlackService;
use Src\Service\LoggerService;
use Src\Service\Reports\ReportService;
use Src\Service\Telegram\TelegramService;
use Symfony\Component\Console\Application;

Config::load(__DIR__ . '/..');

$logger = LoggerService::getLogger();

date_default_timezone_set('Europe/Moscow');

$conn = Database::getConnection($logger);
$repo = new DbalMessageRepository($conn, $logger);
$deepseek = new DeepseekService(Config::get('DEEPSEEK_API_KEY'));
$telegram = new TelegramService();
$slack = new SlackService(Config::get('SLACK_WEBHOOK_URL'));
$notion = new NotionService(Config::get('NOTION_TOKEN'), Config::get('NOTION_DATABASE_ID'));
$report = new ReportService($repo, $deepseek, $telegram, (int)Config::get('SUMMARY_CHAT_ID'), $slack, $notion);

$application = new Application();
$application->add(new DailyReportCommand($report, $logger));
$application->add(new ChatReportCommand($report, $logger));
$application->add(new DailyDigestCommand($report, $logger));
$application->add(new ListChatsCommand($repo, $logger));
$application->add(new ResetProcessedCommand($repo, $logger));
$application->run();

